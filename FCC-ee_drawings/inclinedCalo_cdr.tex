\RequirePackage{luatex85}
\documentclass[a4paper,class=article,border=0pt,crop,tikz]{standalone}
\usepackage{tikz}
\usepackage{pgf}
\usetikzlibrary{shapes.geometric}
\usepackage{color}
\definecolor{myviolet}{RGB}{55,54,112}
\usepackage{pgfplots}
\usepackage{siunitx}
\usetikzlibrary{calc,fadings,decorations.pathreplacing,decorations.pathmorphing,decorations.shapes,spy,arrows,arrows.meta,decorations.markings,fadings}
\usepackage{ifthen}
\pgfplotsset{compat=1.14}
% \usepgfplotslibrary{external}
% \tikzexternalize
\definecolor{violet}{RGB}{55,54,112}
\definecolor{darkgreen}{RGB}{75,141,75}
\definecolor{red}{RGB}{255,41,0}

\definecolor{green}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\definecolor{blue}{rgb}{0.27,0.5,0.8}
\tikzset{
  double arrow/.style args={#1 colored by #2 and #3}{
    ->, >=latex, line width=#1,#2, % first arrow
    postaction={draw,->, >=latex, #3,line width=(#1)/2,
                shorten <=(#1)/4,shorten >=(#1)}, % second arrow
  }
}
%dimensions in decimeters

%FIXME there is something wrong in this drawing: the depth of active is correctly 40 cm, but when getting the length of each layer parallel to the absorber plane using L/cos(50) you dont end up with correct number.... probably due to the the fact that using right-angled triangle is not correct due to the curvature
\begin{document}

\begin{tikzpicture}[xscale=2,yscale=2,spy using outlines={rectangle, magnification=8, size=5cm, height=4cm, connect spies}]\footnotesize
    \spy [ultra thick, black] on (43.65,{3.4-4}) in node [fill=white] at (24.1,{1.9-1.5}); % Since xscale=2, spy coordinate have to be *2...

  % \spy [ultra thick, black] on (39.45,3.4) in node [fill=white] at (25.5,1.5);
  \pgfmathsetmacro{\mynewoffset}{5}
  \pgfmathsetmacro{\rin}{20.7}
  \pgfmathsetmacro{\rout}{27.3}
  \pgfmathsetmacro{\air}{0.3}
  \pgfmathsetmacro{\vacuum}{0.01}
  \pgfmathsetmacro{\calofront}{0.5}
  \pgfmathsetmacro{\caloback}{1}
  \pgfmathsetmacro{\halfcalofront}{{\calofront/2}}
  \pgfmathsetmacro{\halfcaloback}{{\caloback/2}}
  \pgfmathsetmacro{\bathfront}{0.1}
  \pgfmathsetmacro{\bathback}{0.4}
  \pgfmathsetmacro{\angle}{50}
  \pgfmathsetmacro{\absorber}{0.02}
  \pgfmathsetmacro{\readout}{0.012}
  \pgfmathsetmacro{\cell}{0.5} % thickness of the dots showing longitudinal segmentation of the PCB
  \pgfmathsetmacro{\tower}{0.75} % thickness of the arrows chowing the dimensions of cryostat etc
  \pgfmathsetmacro{\numplanes}{1536}
  \pgfmathsetmacro{\dphi}{360./\numplanes}
  \pgfmathsetmacro{\detin}{{\rin+\air+\calofront+\bathfront}} % where sensitive detector starts
  \pgfmathsetmacro{\detout}{{\rout-\air-\caloback-\bathback}}% where sensitive detector ends
  \pgfmathsetmacro{\plane}{sqrt(pow(\detout,2)-pow(\detin*sin(\angle) ,2))-\detin*cos(\angle)} %probably tells the length of the absorbers readout etc, parallel to it
  \message{\plane}
  \pgfmathsetmacro{\r}{{\detin+\plane/2}}
  %\pgfmathsetmacro{\planeFirst}{{(\plane/130*4)*0.5}}  % 130*4 = 520, is linked to the presampler length
  \pgfmathsetmacro{\planeFirst}{{0.2322267}}% is length of the first layers parralle to the plates
  %\pgfmathsetmacro{\planeRest}{{\plane/130*18}} %tells the spacing between longitudinal layers, measured parallel to the readout
  %\pgfmathsetmacro{\planeRest}{{0.544503339}} % the + smth is because using the pythagor is not entirely correct due to the curvature
  \pgfmathsetmacro{\nLayer}{11} % if you change it here you have also to change it in the foreach loops
  \pgfmathsetmacro{\planeRest}{{(\plane-\planeFirst)/\nLayer}}  % if you change the number of layer you have to manually change the number on the arrow (not working properly)
  \message{\planeRest}
  % is the depth of other layers / cos(50) to get the length of these layers parralle to the plates (\detin+\planeFirst+\j*\planeRest) * sin(\phiReadout) is the X spacing between lengitudinal layers dots,  \planeRest)*cos(\phiReadout)   is the Y spacing between lengitudinal layers dots,  phiReadout is the phi angle of the current absorber/gap/readout drawn in global coordinate
  %tells the spacing between longitudinal layers/  18/130=0.1384, ratio with plane first is 4.5
  \message{\planeFirst}
  \pgfmathsetmacro{\phibins}{{int(\numplanes/2)}}
  \pgfmathsetmacro{\dPhiTower}{{360/\phibins}}
  \pgfmathsetmacro{\phiShow}{360/8}
  \pgfmathsetmacro{\phiOffsetFromY}{90-\phiShow/2}
  \pgfmathsetmacro{\phiOffsetFromX}{{\phiOffsetFromY-90}}
  \pgfmathsetmacro{\phiTowerHighlightOne}{-3}
  \pgfmathsetmacro{\highlitedTowerMinOne}{{(\phiTowerHighlightOne-0.5)*360/\phibins}}
  \pgfmathsetmacro{\highlitedTowerMaxOne}{{(\phiTowerHighlightOne+0.5)*360/\phibins}}
  \pgfmathsetmacro{\phiTowerHighlightTwo}{12}
  \pgfmathsetmacro{\highlitedTowerMinTwo}{{(\phiTowerHighlightTwo-0.5)*360/\phibins}}
  \pgfmathsetmacro{\highlitedTowerMaxTwo}{{(\phiTowerHighlightTwo+0.5)*360/\phibins}}
  \pgfmathsetmacro{\phiTowerHighlightThree}{3}
  \pgfmathsetmacro{\highlitedTowerMinThree}{{(\phiTowerHighlightThree-0.5)*360/\phibins}}
  \pgfmathsetmacro{\highlitedTowerMaxThree}{{(\phiTowerHighlightThree+0.5)*360/\phibins}}
  \pgfmathsetmacro{\shownumplanes}{int(\numplanes/(360/\phiShow))}
  \pgfmathsetmacro{\showphibins}{int(\phibins/(360/\phiShow))}
  \pgfmathsetmacro{\ione}{{86}} % tells which cell number you put the arrow on to show its length for the presampler, the lower it is the higher the arrow
  \pgfmathsetmacro{\itwo}{{93}} % tells which cell number you put the arrow on to show its length for the second layer
  \ifthenelse{\angle=50 \and \numplanes=1408}
  { \pgfmathsetmacro{\ione}{{81.5}}
    \pgfmathsetmacro{\itwo}{{88.5}}
  }{\ifthenelse{\angle=30 \and \numplanes=1408}
    { \pgfmathsetmacro{\ione}{{81.5}}
      \pgfmathsetmacro{\itwo}{{84.5}}
    }{\ifthenelse{\angle=0 \and \numplanes=1408}
      { \pgfmathsetmacro{\ione}{{80.5}}
        \pgfmathsetmacro{\itwo}{{78.5}}
      }{\ifthenelse{\angle=50 \and \numplanes=1280}
        { \pgfmathsetmacro{\ione}{{73.5}}
          \pgfmathsetmacro{\itwo}{{79.5}}
        }{\ifthenelse{\angle=30 \and \numplanes=1280}
          { \pgfmathsetmacro{\ione}{{73.5}}
            \pgfmathsetmacro{\itwo}{{76.5}}
          }{\ifthenelse{\angle=0 \and \numplanes=1280}
            { \pgfmathsetmacro{\ione}{{72.5}}
              \pgfmathsetmacro{\itwo}{{70.5}}
            }{
            }
          }
        }
      }
    }
  }


  \clip ({0.9*\rin},{-\rin/5.25}) rectangle ({0.99*\rout}, {\rin/8});
  %\clip ({1.05*\rin},{-\rin/10}) rectangle ({1.3*\rin}, {\rin/10});

  % CRYOSTAT
  \begin{scope}[black!30]
    \fill (0,0)  ++(\phiOffsetFromX:{\rout-\air+\vacuum}) arc (\phiOffsetFromX:{\phiOffsetFromX+\phiShow}:{\rout-\air+\vacuum});
    \fill[fill=white] (0,0) ++(\phiOffsetFromX:{\rout-\air+\vacuum-\halfcaloback})  arc (\phiOffsetFromX:{\phiOffsetFromX+\phiShow}:{\rout-\air+\vacuum-\halfcaloback});
    \fill (0,0) ++ (\phiOffsetFromX:{\rout-\air-\halfcaloback}) arc (\phiOffsetFromX:{\phiOffsetFromX+\phiShow}:{\rout-\air-\halfcaloback});
    \fill[fill=violet!10] (0,0) ++(\phiOffsetFromX:{\rout-\air-\caloback}) arc (\phiOffsetFromX:{\phiOffsetFromX+\phiShow}:{\rout-\air-\caloback})
    -- ({\phiOffsetFromX+\phiShow}:{\rin+\air+\calofront}) arc ({\phiOffsetFromX+\phiShow}:\phiOffsetFromX:{\rin+\air+\calofront}) -- (\phiOffsetFromX:{\rout-\air-\caloback});
    \fill (0,0) ++(\phiOffsetFromX:{\rin+\air+\calofront}) arc (\phiOffsetFromX:{\phiOffsetFromX+\phiShow}:{\rin+\air+\calofront});
    \fill[fill=white] (0,0) ++ (\phiOffsetFromX:{\rin+\air+\halfcalofront}) arc (\phiOffsetFromX:{\phiOffsetFromX+\phiShow}:{\rin+\air+\halfcalofront});
    \fill (0,0) ++(\phiOffsetFromX:{\rin+\air-\vacuum+\halfcalofront}) arc (\phiOffsetFromX:{\phiOffsetFromX+\phiShow}:{\rin+\air-\vacuum+\halfcalofront});
    \fill[fill=white] (0,0) ++(\phiOffsetFromX:{\rin+\air-\vacuum}) arc (\phiOffsetFromX:{\phiOffsetFromX+\phiShow}:{\rin+\air-\vacuum});
  \end{scope}


% NB: (xA, yA) is the point at the midle of the absorber inner part, (xC, yC) is the point in the middle of the absorber outer part, xB yB are the coordinates of the point in the middle of the absorber if there was no inclination
\iftrue
  % ABSORBER - only outer in the first layer
  \begin{scope}[red!80, line width = 0.005]
    \foreach \i in {0,..., \shownumplanes}
    {
      \pgfmathsetmacro{\phi}{{\phiOffsetFromY+\i*\dphi}}
      % centre of radial i.e.
      \pgfmathsetmacro{\xB}{{(\detin+\plane/2)*sin(\phi)}}
      \pgfmathsetmacro{\yB}{{(\detin+\plane/2)*cos(\phi)}}
      % position of begining of a plane
      \pgfmathsetmacro{\xA}{{\detin*sin(\phi)}}
      \pgfmathsetmacro{\yA}{{\detin*cos(\phi)}}
      % rotated plane
      \pgfmathsetmacro{\xC}{{\xA+2*(\xB-\xA)*cos(\angle)-2*(\yB-\yA)*sin(\angle)}}
      \pgfmathsetmacro{\yC}{{\yA+2*(\xB-\xA)*sin(\angle)+2*(\yB-\yA)*cos(\angle)}}
      % new begining of a plane
      \pgfmathsetmacro{\xA}{{\xA+\planeFirst*sin(\phi)*cos(\angle)-\planeFirst*cos(\phi)*sin(\angle)}}
      \pgfmathsetmacro{\yA}{{\yA+\planeFirst*sin(\phi)*sin(\angle)+\planeFirst*cos(\phi)*cos(\angle)}}
      % rectangle halfwidth
      \pgfmathsetmacro{\xShift}{{(\absorber/2)*sin(\angle)}}
      \pgfmathsetmacro{\yShift}{{(\absorber/2)*cos(\angle)}}

      \fill ({\xA-\xShift}, {\yA+\yShift}) -- ({\xA+\xShift}, {\yA-\yShift})
      -- ({\xC+\xShift}, {\yC-\yShift})    -- ({\xC-\xShift}, {\yC+\yShift})
      -- ({\xA-\xShift}, {\yA+\yShift}) ;
    }
  \end{scope}
  % ABSORBER - not in the first layer
  \begin{scope}[red!80, line width = 0.005]
    \foreach \i in {0,..., \shownumplanes}
    {
      \pgfmathsetmacro{\phi}{{\phiOffsetFromY+\i*\dphi}}
      % centre of radial
      \pgfmathsetmacro{\xB}{{(\detin+\planeFirst/2)*sin(\phi)}}
      \pgfmathsetmacro{\yB}{{(\detin+\planeFirst/2)*cos(\phi)}}
      % position of begining of a plane
      \pgfmathsetmacro{\xA}{{\detin*sin(\phi)}}
      \pgfmathsetmacro{\yA}{{\detin*cos(\phi)}}
      % rotated plane
      \pgfmathsetmacro{\xC}{{\xA+2*(\xB-\xA)*cos(\angle)-2*(\yB-\yA)*sin(\angle)}}
      \pgfmathsetmacro{\yC}{{\yA+2*(\xB-\xA)*sin(\angle)+2*(\yB-\yA)*cos(\angle)}}
      % rectangle halfwidth
      \pgfmathsetmacro{\xShift}{{(\absorber/2)*sin(\angle)}}
      \pgfmathsetmacro{\yShift}{{(\absorber/2)*cos(\angle)}}
      \pgfmathsetmacro{\xShiftThin}{{(\absorber/5.4)*sin(\angle)}}
      \pgfmathsetmacro{\yShiftThin}{{(\absorber/5.4)*cos(\angle)}}

      \fill[violet!10] ({\xA-\xShift}, {\yA+\yShift}) -- ({\xA+\xShift}, {\yA-\yShift})
      -- ({\xC+\xShift}, {\yC-\yShift})    -- ({\xC-\xShift}, {\yC+\yShift})
      -- ({\xA-\xShift}, {\yA+\yShift}) ;

      \fill ({\xA-\xShift}, {\yA+\yShift}) % pocz lewa
      -- ({\xA-\xShift+\xShiftThin}, {\yA+\yShift-\yShiftThin}) % pocz prawa
      -- ({\xC-\xShift+\xShiftThin}, {\yC+\yShift-\yShiftThin}) % kon prawa
      -- ({\xC-\xShift}, {\yC+\yShift}) % kon lewa
      -- ({\xA-\xShift}, {\yA+\yShift}) ; % back

      \fill ({\xA+\xShift-\xShiftThin}, {\yA-\yShift+\yShiftThin}) % pocz lewa
      -- ({\xA+\xShift}, {\yA-\yShift}) % pocz prawa
      -- ({\xC+\xShift}, {\yC-\yShift}) % kon prawa
      -- ({\xC+\xShift-\xShiftThin}, {\yC-\yShift+\yShiftThin}) % kon lewa
      -- ({\xA+\xShift-\xShiftThin}, {\yA-\yShift+\yShiftThin}) ; % back
    }
  \end{scope}
  % READOUT
  \begin{scope}[green!80, line width = 0.005]
    \foreach \i in {0,..., \shownumplanes}
    {
      \pgfmathsetmacro{\phi}{{\phiOffsetFromY+(0.5+\i)*\dphi}}
      % centre of radial
      \pgfmathsetmacro{\xB}{{(\detin+\plane/2)*sin(\phi)}}
      \pgfmathsetmacro{\yB}{{(\detin+\plane/2)*cos(\phi)}}
      % position of begining of a plane
      \pgfmathsetmacro{\xA}{{\detin*sin(\phi)}}
      \pgfmathsetmacro{\yA}{{\detin*cos(\phi)}}
      % rotated plane
      \pgfmathsetmacro{\xC}{{\xA+2*(\xB-\xA)*cos(\angle)-2*(\yB-\yA)*sin(\angle)}}
      \pgfmathsetmacro{\yC}{{\yA+2*(\xB-\xA)*sin(\angle)+2*(\yB-\yA)*cos(\angle)}}
      % rectangle halfwidth
      \pgfmathsetmacro{\xShift}{{(\readout/2)*sin(\angle)}}
      \pgfmathsetmacro{\yShift}{{(\readout/2)*cos(\angle)}}

      \fill ({\xA-\xShift}, {\yA+\yShift}) -- ({\xA+\xShift}, {\yA-\yShift})
      -- ({\xC+\xShift}, {\yC-\yShift})    -- ({\xC-\xShift}, {\yC+\yShift})
      -- ({\xA-\xShift}, {\yA+\yShift}) ;
    }
  \end{scope}

  % CELLS: longitudinal borders  %Draw the separation dots in longitudinal readout layers

  \begin{scope}[black, line width = {\cell}]
    \foreach \i in {0,..., \shownumplanes}
    {
      \pgfmathsetmacro{\phiReadout}{{\phiOffsetFromY+(\i+0.5)*\dphi}}
      % centre of unrotated plane
      \pgfmathsetmacro{\xBFirst}{{(\detin)*sin(\phiReadout)}} % beginning of detector
      \pgfmathsetmacro{\yBFirst}{{(\detin)*cos(\phiReadout)}}
      \pgfmathsetmacro{\xBnext}{{(\detin+\planeFirst)*sin(\phiReadout)}} % end of first layer
      \pgfmathsetmacro{\yBnext}{{(\detin+\planeFirst)*cos(\phiReadout)}}
      % begin of plane
      \pgfmathsetmacro{\xAFirst}{{\detin*sin(\phiReadout)}}
      \pgfmathsetmacro{\yAFirst}{{\detin*cos(\phiReadout)}}
      % rotated plane
      \pgfmathsetmacro{\xCFirst}{{\xAFirst+(\xBFirst-\xAFirst)*cos(\angle)-(\yBFirst-\yAFirst)*sin(\angle)}}
      \pgfmathsetmacro{\yCFirst}{{\yAFirst+(\xBFirst-\xAFirst)*sin(\angle)+(\yBFirst-\yAFirst)*cos(\angle)}}
      \pgfmathsetmacro{\xCnext}{{\xAFirst+(\xBnext-\xAFirst)*cos(\angle)-(\yBnext-\yAFirst)*sin(\angle)}}
      \pgfmathsetmacro{\yCnext}{{\yAFirst+(\xBnext-\xAFirst)*sin(\angle)+(\yBnext-\yAFirst)*cos(\angle)}}

      \pgfmathsetmacro{\cellInThickness}{{\readout/2}};
      \pgfmathsetmacro{\cellOutThickness}{{\readout/2}};

      \pgfmathsetmacro{\phiCentre}{{atan((\yCFirst+\yCnext)/(\xCFirst+\xCnext))}};
      \foreach \j in {0,..., 10}
      {
      %Draw the separation dots in longitudinal readout layers
        \pgfmathsetmacro{\xB}{{(\detin+\planeFirst+\j*\planeRest)*sin(\phiReadout)}};
        \pgfmathsetmacro{\yB}{{(\detin+\planeFirst+\j*\planeRest)*cos(\phiReadout)}};
        \pgfmathsetmacro{\xBnext}{{(\detin+\planeFirst+(\j+1)*\planeRest)*sin(\phiReadout)}};
        \pgfmathsetmacro{\yBnext}{{(\detin+\planeFirst+(\j+1)*\planeRest)*cos(\phiReadout)}};
        \pgfmathsetmacro{\xA}{{\detin*sin(\phiReadout)}};
        \pgfmathsetmacro{\yA}{{\detin*cos(\phiReadout)}};
        \pgfmathsetmacro{\xC}{{\xA+(\xB-\xA)*cos(\angle)-(\yB-\yA)*sin(\angle)}};
        \pgfmathsetmacro{\yC}{{\yA+(\xB-\xA)*sin(\angle)+(\yB-\yA)*cos(\angle)}};
        \pgfmathsetmacro{\xCnext}{{\xA+(\xBnext-\xA)*cos(\angle)-(\yBnext-\yA)*sin(\angle)}};
        \pgfmathsetmacro{\yCnext}{{\yA+(\xBnext-\xA)*sin(\angle)+(\yBnext-\yA)*cos(\angle)}};

        \pgfmathsetmacro{\phiCentre}{{atan((\yC+\yCnext)/2/((\xC+\xCnext)/2))}}
             \draw ({\xC - (\cellOutThickness)*cos(-\angle+\phiReadout)}, {\yC + (\cellOutThickness)*sin(-\angle+\phiReadout)})
              -- ({\xC + (\cellOutThickness)*cos(-\angle+\phiReadout)}, {\yC - (\cellOutThickness)*sin(-\angle+\phiReadout)});
      }
    }
  \end{scope}

\fi




  % % tower
  % \begin{scope}[black, line width = \tower]
  %   \foreach \i in {0,..., \showphibins}
  %   {
  %     \pgfmathsetmacro{\phiTower}{{\phiOffsetFromX+(\i+0.5)*\dPhiTower}}
  %     \draw ({\phiTower}:\detin) -- ({\phiTower}: \detout);
  %   }
  % \end{scope}

  % \begin{scope}[black!20]
  %   \draw[dashed] (0,0) ++ (30:{\rin}) arc (30:-30:{\rin});
  %   \draw[dashed] (0,0) ++ (30:{\rout}) arc (30:-30:{\rout});
  % \end{scope}

  \fill[white] ({0.85*\rin},{\rin/5.25}) rectangle ({1.1*\rout}, {\rin/3});

  \begin{scope}[black, line width = {\tower*2}]
    \pgfmathsetmacro{\dPhiTowerRadians}{{6.28/\phibins}};
    \pgfmathsetmacro{\phiCluster}{{\phiTowerHighlightTwo-\phiTowerHighlightOne}};
    \pgfmathsetmacro{\dPhiClusterRadians}{{6.28/\phibins*\phiCluster}};
    % \pgfmathsetmacro{\phitextOne}{90+\highlitedTowerMinOne*\dphi};
    % \message{\phitextOne};
    % \draw[<->,line width = {\tower}, >=latex, bend right] ({\highlitedTowerMinOne}:{\detout+0.1}) -- ({\highlitedTowerMaxOne}:{\detout+0.1}) node [below, midway,,rotate=\phitextOne] {\Large $\frac{2\pi}{\phibins}$};
    % \pgfmathsetmacro{\phitextThree}{90+\highlitedTowerMinThree*\dphi};
    % \draw[<->, >=latex, line width = {\tower},bend right] (\highlitedTowerMinThree:{\detout+0.1}) -- ({\highlitedTowerMaxThree}:{\detout+0.1}) node [below, midway,rotate=\phitextThree] {\large \num[round-mode=places,round-precision=4]{\dPhiTowerRadians} rad};
    % \pgfmathsetmacro{\phitextTwo}{90+\highlitedTowerMinTwo*\dphi};
    % \draw[<->, >=latex, line width = {\tower},bend right] ({\highlitedTowerMinTwo}:{\detout+0.1}) -- ({\highlitedTowerMaxTwo}:{\detout+0.1}) node [below, midway ,rotate=\phitextTwo] {\large {\dPhiTower}$^\circ$};
    % \pgfmathsetmacro{\phitextCluster}{{90+(\phiTowerHighlightTwo-\phiTowerHighlightOne)*\dphi}};
    % \draw[<->,line width = {\tower}, >=latex] (0,0) ++ ({\highlitedTowerMaxTwo}:{\detout+0.1}) arc ({\highlitedTowerMaxTwo}:{\highlitedTowerMinOne}:{\detout+0.1}) node [below, midway,rotate=\phitextCluster] {\large \num[round-mode=places,round-precision=0]{\phiCluster}$\Delta\varphi$ = \num[round-mode=places,round-precision=3]{\dPhiClusterRadians} rad};
    % \spy [blue] on (20,0{\rin},0) in node [fill=white] at (25,1.5);
%    \draw[->,>=latex] (-3:{\rin-5}) -- (-3:\rin+\air-\vacuum) node [at end, above, xshift=-1cm, rotate=-3] {\textbf{\LARGE 185 cm}};
    \draw[->,>=latex] (-5:{\rin-5}) -- (-5:\rout-\air+\vacuum) node [at end, above, xshift=-1cm, yshift=0.05cm, rotate=-5] {\textbf{\LARGE 270 cm}};
    \draw[->,>=latex] (-4:{\rin-5}) -- (-4:\rin+\air-\vacuum) node [at end, above, xshift=-1cm, rotate=-4] {\textbf{\LARGE 210 cm}};
    \draw[->,>=latex] (-6:{\rin-5}) -- (-6:\detout) node [at end, xshift=-1.2cm, yshift=0.4cm, rotate=-6] {\textbf{\LARGE 256 cm}};
    \draw[<->,>=latex] (-7:\detin) -- (-7:\detout) node [above,midway,rotate=-7] {\textbf{\LARGE 40 cm}};
    % \draw[<->,>=latex] (-8:{\rin+\air-\vacuum}) -- (-8:\rin) node [above, near end, xshift=0.2cm, rotate=-8] {\large 3 cm};
    % \draw[<->,>=latex] (-6.:{\rout-\air+\vacuum}) -- (-6.:\rout) node [above, near end, xshift=-0.05cm, rotate=-6.] {\large 3 cm};
    \draw[<->,>=latex] (-8:{\rin+\air-\vacuum}) -- (-8:\rin+\air+\calofront) node [above, xshift=-0.5cm, yshift=0.1cm, rotate=-8] {\textbf{\LARGE 5 cm}};
    \draw[<->,>=latex] (-7:{\detout+\bathback}) -- (-7:\detout+\bathback+\caloback+\vacuum) node [above, xshift=-1cm, yshift=0.1cm, rotate=-7] {\textbf{\LARGE 10 cm}};
    %% \node (angLabel) at (6:{\rout-1}) {\Huge\bf {\numplanes} absorbers};
    %% \node (angLabel) at ({{0.86*\rin+(0.99*\rout-0.86*\rin)/2}},4.3) {\Huge\textbf{FCC-hh barrel ECAL}};
%%%%%    \node [below of = planeLabel] {\Huge{ $\Delta\varphi=$\num[round-mode=places,round-precision=4]{\dPhiTowerRadians}}};

    % Text And Arrows
    \node[black!80] at (19.5,2.7-1.2) {\huge 1st layer};
    \node[black!80] at (19.5,2.4-1.2) {\large (presampler)};
    \node[black!80] at (19.5,2.18-1.2) {\large no Pb};
    \draw[double arrow=4pt colored by white and black!95] (20.2,1.5) -- (21.58, 1.6);

    \node[black!60] at (19.5,0.3) {\huge cryostat};
    \draw[double arrow=4pt colored by white and black!65] (20.1,0.3) -- (21.1, 0.27);


    \fill[white] (20,2.1) rectangle (28,4);
    \node[violet!80] at (22.2,2.37) {\large active gap (noble liquid)};
    %\draw[double arrow=4pt colored by white and violet!80] (22.1,2.2) -- (21.45, 1.7); %towards services bath
    \draw[double arrow=3pt colored by white and violet!80] (22.2,2.2) -- (22.2+1.51, 1.4); %towards mangification box
    \node[red!80] at (22.2+1.7,2.4) {\large absorber};
    \draw[double arrow=3pt colored by white and red!80] (22.2+1.7,2.2) -- (24.5+0.26, 1.4);
    \node[green!80] at (22.2+1.7+1.4,2.4) {\large readout electrode};
    \draw[double arrow=3pt colored by white and green!80] (22.2+1.7+1.4,2.2) -- (22.2+1.7+1.55-0.41, 1.4);



  \end{scope}


  % CELLS: longitudinal borders
  \begin{scope}[violet!80, line width = \cell]
    \foreach \i in {0,..., \shownumplanes}
    {
      \pgfmathsetmacro{\phiReadout}{{\phiOffsetFromY+(\i)*\dphi}}
      % centre of unrotated plane
      \pgfmathsetmacro{\xBFirst}{{(\detin)*sin(\phiReadout)}} % beginning of detector
      \pgfmathsetmacro{\yBFirst}{{(\detin)*cos(\phiReadout)}}
      \pgfmathsetmacro{\xBnext}{{(\detin+\planeFirst)*sin(\phiReadout)}} % end of first layer
      \pgfmathsetmacro{\yBnext}{{(\detin+\planeFirst)*cos(\phiReadout)}}
      % begin of plane
      \pgfmathsetmacro{\xAFirst}{{\detin*sin(\phiReadout)}}
      \pgfmathsetmacro{\yAFirst}{{\detin*cos(\phiReadout)}}
      % rotated plane
      \pgfmathsetmacro{\xCFirst}{{\xAFirst+(\xBFirst-\xAFirst)*cos(\angle)-(\yBFirst-\yAFirst)*sin(\angle)}}
      \pgfmathsetmacro{\yCFirst}{{\yAFirst+(\xBFirst-\xAFirst)*sin(\angle)+(\yBFirst-\yAFirst)*cos(\angle)}}
      \pgfmathsetmacro{\xCnext}{{\xAFirst+(\xBnext-\xAFirst)*cos(\angle)-(\yBnext-\yAFirst)*sin(\angle)}}
      \pgfmathsetmacro{\yCnext}{{\yAFirst+(\xBnext-\xAFirst)*sin(\angle)+(\yBnext-\yAFirst)*cos(\angle)}}
      \pgfmathsetmacro{\activeInThickness}{{\detin*sin(\dphi/2.)*cos(\angle)}};
      \pgfmathsetmacro{\activeOutThickness}{{\detin+\plane)*sin(\dphi/2.)*cos(\angle)}};
      \pgfmathsetmacro{\xIntersect}{{(\detin*(tan(\angle)-cos(\dphi/2)*tan(\angle+\dphi/2))-\plane*sin(\dphi/2))/(tan(\angle)-tan(\angle+\dphi/2))}};
      \pgfmathsetmacro{\yIntersect}{{tan(\angle)*\xIntersect+\detin*(sin(\dphi/2)-tan(\angle))+\plane*sin(\dphi/2)}};
      \pgfmathsetmacro{\correction}{{\plane-sqrt(pow(\xIntersect-\detin*cos(\dphi/2),2)+pow(\yIntersect-\detin*sin(\dphi/2),2))}};
      \pgfmathsetmacro{\activeOutThickness}{{\activeOutThickness+2*\correction*sin(\dphi/4.)}};
      \pgfmathsetmacro{\cellIncrease}{{(\activeOutThickness-\activeInThickness) / 130}};
      \pgfmathsetmacro{\cellInThickness}{{\activeInThickness}};
      \pgfmathsetmacro{\cellOutThickness}{{\activeInThickness + \cellIncrease * 4}};

      \pgfmathsetmacro{\phiCentre}{{atan((\yCFirst+\yCnext)/(\xCFirst+\xCnext))}}

% put the arrow showing the length of the presampler cell
      \ifthenelse{\i=\ione}
      {
        \message{\planeFirst};
        \pgfmathsetmacro{\planeFirstInCm}{{10.*\planeFirst}};
        % \fill[%decorate, decoration={random steps,segment length=0.2mm, amplitude=0.01mm},
        % thick, rounded corners=1ex,,white,fill opacity=0.7]  ({\xCFirst}, {\yCFirst})  circle ({\planeFirst});

        %\draw[<->,>=latex,black,line width=1pt] ({\xCFirst + \cellInThickness*cos(-\angle+\phiReadout)}, {\yCFirst - \cellInThickness*sin(-\angle+\phiReadout)}) -- ({\xCnext + \cellOutThickness*cos(-
        %\angle+\phiReadout)}, {\yCnext - \cellOutThickness*sin(-\angle+\phiReadout)}) node [above, midway, rotate={90+\angle-\phiReadout}] {\LARGE \num[round-mode=places,round-precision=2]{\planeFirstInCm} cm};

        \draw[<->,>=latex,black,line width=1pt] ({\xCFirst}, {\yCFirst}) -- ({\xCnext}, {\yCnext}) node [above, midway, rotate={90+\angle-\phiReadout}] {\LARGE \num[round-mode=places,round-precision=2]{2.12} cm};
      } {}
    % put the arrow showing the length of the second cell (the foreach is in case you want it everywhere but here there is another condition after that)
      \foreach \j in {0,..., 10}
      {
        \pgfmathsetmacro{\xB}{{(\detin+\planeFirst+\j*\planeRest)*sin(\phiReadout)}};
        \pgfmathsetmacro{\yB}{{(\detin+\planeFirst+\j*\planeRest)*cos(\phiReadout)}};
        \pgfmathsetmacro{\xBnext}{{(\detin+\planeFirst+(\j+1)*\planeRest)*sin(\phiReadout)}};
        \pgfmathsetmacro{\yBnext}{{(\detin+\planeFirst+(\j+1)*\planeRest)*cos(\phiReadout)}};
        \pgfmathsetmacro{\xA}{{\detin*sin(\phiReadout)}};
        \pgfmathsetmacro{\yA}{{\detin*cos(\phiReadout)}};
        \pgfmathsetmacro{\xC}{{\xA+(\xB-\xA)*cos(\angle)-(\yB-\yA)*sin(\angle)}};
        \pgfmathsetmacro{\yC}{{\yA+(\xB-\xA)*sin(\angle)+(\yB-\yA)*cos(\angle)}};
        \pgfmathsetmacro{\xCnext}{{\xA+(\xBnext-\xA)*cos(\angle)-(\yBnext-\yA)*sin(\angle)}};
        \pgfmathsetmacro{\yCnext}{{\yA+(\xBnext-\xA)*sin(\angle)+(\yBnext-\yA)*cos(\angle)}};

        \pgfmathsetmacro{\phiCentre}{{atan((\yC+\yCnext)/2/((\xC+\xCnext)/2))}}
        \ifthenelse{\i=\itwo \and \j=0}
        {
          \message{\planeRest};
          \pgfmathsetmacro{\planeRestInCm}{{10.*\planeRest}};
          \pgfmathsetmacro{\planeRestInCm}{{4.94}};
          % \fill[%decorate, decoration={random steps,segment length=0.2mm, amplitude=0.01mm},
          % Draw the arrow on regular cells thick, rounded corners=1ex,,white, opacity=0.6]  ({\xC}, {\yC}) circle ({\planeRest});
          %\draw[<->,>=latex, ultra thick,black]({\xC + \cellInThickness*cos(-\angle+\phiReadout)}, {\yC - \cellInThickness*sin(-\angle+\phiReadout)}) -- ({\xCnext + \cellOutThickness*cos(-\angle+\phiReadout)}, {\yCnext - \cellOutThickness*sin(-\angle+\phiReadout)}) node [above, midway, rotate={90+\angle-\phiReadout}] {\LARGE \num[round-mode=places,round-precision=2]{\planeRestInCm} cm};
           \draw[<->,>=latex, ultra thick,black]({\xC}, {\yC}) -- ({\xCnext}, {\yCnext}) node [above, midway, rotate={90+\angle-\phiReadout}] {\LARGE \num[round-mode=places,round-precision=2]{\planeRestInCm} cm};
        } {}
      }
    }
  \end{scope}

  % \draw[step=0.1,black,thin] (0,0) grid (20,20);
  % \draw[step=1,black] (0,0) grid (20,20);
\end{tikzpicture}
\end{document}
