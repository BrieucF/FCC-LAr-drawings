\documentclass[12pt,crop,tikz]{standalone}
\usepackage{tikz}
\usepackage{ifthen}
\usepackage{listofitems}
\usetikzlibrary{math}
\usepackage{pgfplots}
\usetikzlibrary{colorbrewer}
\usepgfplotslibrary{colorbrewer}
\pgfplotsset{compat=1.16}
\usetikzlibrary{positioning}
\newcounter{numCells}
\newcounter{totalNumCells}
\setcounter{totalNumCells}{0}
\begin{document}
\pagestyle{empty}
\pgfplotsset{ticks=none}
\pgfplotsset{yticklabels=\empty}
\pgfplotsset{xticklabels=\empty}
\pgfplotsset{
    colormap={parula}{
        rgb=(1,1,1)
        rgb=(0.2081,0.1663,0.5292)
        rgb=(0.2116,0.1898,0.5777)
        rgb=(0.2123,0.2138,0.627)
        rgb=(0.2081,0.2386,0.6771)
        rgb=(0.1959,0.2645,0.7279)
        rgb=(0.1707,0.2919,0.7792)
        rgb=(0.1253,0.3242,0.8303)
        rgb=(0.0591,0.3598,0.8683)
        rgb=(0.0117,0.3875,0.882)
        rgb=(0.006,0.4086,0.8828)
        rgb=(0.0165,0.4266,0.8786)
        rgb=(0.0329,0.443,0.872)
        rgb=(0.0498,0.4586,0.8641)
        rgb=(0.0629,0.4737,0.8554)
        rgb=(0.0723,0.4887,0.8467)
        rgb=(0.0779,0.504,0.8384)
        rgb=(0.0793,0.52,0.8312)
        rgb=(0.0749,0.5375,0.8263)
        rgb=(0.0641,0.557,0.824)
        rgb=(0.0488,0.5772,0.8228)
        rgb=(0.0343,0.5966,0.8199)
        rgb=(0.0265,0.6137,0.8135)
        rgb=(0.0239,0.6287,0.8038)
        rgb=(0.0231,0.6418,0.7913)
        rgb=(0.0228,0.6535,0.7768)
        rgb=(0.0267,0.6642,0.7607)
        rgb=(0.0384,0.6743,0.7436)
        rgb=(0.059,0.6838,0.7254)
        rgb=(0.0843,0.6928,0.7062)
        rgb=(0.1133,0.7015,0.6859)
        rgb=(0.1453,0.7098,0.6646)
        rgb=(0.1801,0.7177,0.6424)
        rgb=(0.2178,0.725,0.6193)
        rgb=(0.2586,0.7317,0.5954)
        rgb=(0.3022,0.7376,0.5712)
        rgb=(0.3482,0.7424,0.5473)
        rgb=(0.3953,0.7459,0.5244)
        rgb=(0.442,0.7481,0.5033)
        rgb=(0.4871,0.7491,0.484)
        rgb=(0.53,0.7491,0.4661)
        rgb=(0.5709,0.7485,0.4494)
        rgb=(0.6099,0.7473,0.4337)
        rgb=(0.6473,0.7456,0.4188)
        rgb=(0.6834,0.7435,0.4044)
        rgb=(0.7184,0.7411,0.3905)
        rgb=(0.7525,0.7384,0.3768)
        rgb=(0.7858,0.7356,0.3633)
        rgb=(0.8185,0.7327,0.3498)
        rgb=(0.8507,0.7299,0.336)
        rgb=(0.8824,0.7274,0.3217)
        rgb=(0.9139,0.7258,0.3063)
        rgb=(0.945,0.7261,0.2886)
        rgb=(0.9739,0.7314,0.2666)
        rgb=(0.9938,0.7455,0.2403)
        rgb=(0.999,0.7653,0.2164)
        rgb=(0.9955,0.7861,0.1967)
        rgb=(0.988,0.8066,0.1794)
        rgb=(0.9789,0.8271,0.1633)
        rgb=(0.9697,0.8481,0.1475)
        rgb=(0.9626,0.8705,0.1309)
        rgb=(0.9589,0.8949,0.1132)
        rgb=(0.9598,0.9218,0.0948)
        rgb=(0.9661,0.9514,0.0755)
        rgb=(0.9763,0.9831,0.0538)
    }
}

\pgfplotsset{
    colormap={root}{
        rgb=(1,1,1)
        rgb=(1,1,1)
        rgb=(1,1,1)
        rgb=(0.298,0.573,0.824)
        rgb=(0.361,0.557,0.804)
        rgb=(0.420,0.510,0.769)
        rgb=(0.475,0.447,0.714)
        rgb=(0.533,0.376,0.659)
        rgb=(0.604,0.357,0.608)
        rgb=(0.678,0.333,0.553)
        rgb=(0.733,0.361,0.510)
        rgb=(0.784,0.439,0.471)
        rgb=(0.835,0.518,0.431)
        rgb=(0.855,0.592,0.416)
        rgb=(0.875,0.659,0.400)
        rgb=(0.863,0.706,0.400)
        rgb=(0.820,0.725,0.416)
        rgb=(0.776,0.745,0.435)
        rgb=(0.686,0.667,0.439)
        rgb=(0.588,0.576,0.443)
        rgb=(0.451,0.447,0.376)
        rgb=(0.271,0.267,0.231)
        rgb=(0,0,0)
    }
}

%% fixed window
\def\dEta{{7,7,7,7,7,7,7,7}}
\def\dPhi{{19,19,19,19,19,19,19,19}}
\def\ellipse{0}
\def\dEta{{3,3,3,3,3,3,3,3}}
\def\dPhi{{9,9,9,9,9,9,9,9}}
\def\ellipse{0}
%% %% fixed window - ellipse
\def\dEta{{7,7,7,7,7,7,7,7}}
\def\dPhi{{13,13,13,13,13,13,13,13}}
\def\ellipse{1}
\def\dEta{{3,3,3,3,3,3,3,3}}
\def\dPhi{{9,9,9,9,9,9,9,9}}
\def\ellipse{1}
%% %% 50 GeV rect 90%
%% \def\dEta{{5,1,3,3,5,7,9,11}}
%% \def\dPhi{{21,17,9,13,15,19,23,27}}
%% \def\ellipse{0}
%% %% 50 GeV ellipse 90%
%% \def\dEta{{7,3,3,5,7,9,13,15}}
%% \def\dPhi{{21,9,11,11,15,19,21,25}}
%% \def\ellipse{1}
%% %% %% 50 GeV rect 85%
%% %% \def\dEta{{3,1,1,3,3,5,7,11}}
%% %% \def\dPhi{{17,9,13,9,17,17,21,19}}
%% %% \def\ellipse{0}
%% %% 50 GeV ellipse 85%
%% \def\dEta{{3,3,3,3,5,7,11,13}}
%% \def\dPhi{{27,7,9,11,15,17,19,21}}
%% \def\ellipse{1}

\begin{tikzpicture}[scale=.9,every node/.style={minimum size=1cm},on grid]
  \pgfmathsetmacro{\dr}{5/30.}
    \begin{scope}[
            xshift=0,every node/.append style={
            xslant=0,yslant=0.85}, xslant=0,yslant=-1.25, xscale=0.75, yscale=1.25
            ]
        \fill[white,fill opacity=0.9] (0,0) rectangle (5,5);
        \draw[black,very thick] (0,0) rectangle (5,5);
	      \begin{axis}[view={0}{90},
            width = 6.59cm, height = 6.59cm,
            zmin=-13, zmax=0,
            point meta min = -13, point meta max = 0,
          ]
          \addplot3[surf,
            shader=flat corner,
            mesh/cols=31,
            mesh/rows=31,
            mesh/ordering=rowwise] file {data_scaled_log_layer7.csv};
	      \end{axis}
        \pgfmathsetmacro\hdeta{\dEta[7]}
        \pgfmathsetmacro\hdphi{\dPhi[7]}
        \pgfmathsetmacro\hdetaminus{\dEta[7] - 1}
        \pgfmathsetmacro\hdphiminus{\dPhi[7] - 1}
        \pgfmathsetmacro\hdetaStart{-31/2+\hdeta/2}
        \pgfmathsetmacro\hdphiStart{-31/2+\hdphi/2}
        \pgfmathsetmacro\hdetaEnd{\hdetaStart + 30 - 1}
        \pgfmathsetmacro\hdphiEnd{\hdphiStart + 30 - 1}
        \setcounter{numCells}{0}
        \ifnum\ellipse=0
        \foreach \ieta in {\hdetaStart, ..., -1} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {0, ..., \hdetaminus} {
          \foreach \iphi in {\hdphiStart, ..., -1} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          \foreach \iphi in {\hdphi, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
        }
        \foreach \ieta in {\hdeta, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
          }{}
        }
        \else
        \foreach \ieta in {\hdetaStart, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \pgfmathsetmacro\radius{ (\ieta - (0.5 * \hdeta - 0.5)) * (\ieta - (0.5 * \hdeta - 0.5)) / ((0.5 * \hdeta) * (0.5 * \hdeta))
              + (\iphi - (0.5 * \hdphi - 0.5)) * (\iphi - (0.5 * \hdphi - 0.5)) / ((0.5 * \hdphi) * (0.5 * \hdphi))}
            \ifthenelse { \lengthtest{\radius pt < 1.0 pt}} {
            \addtocounter{numCells}{1};
            }{
              \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            }
          }
        }
        \fi
        \node[xslant=0,yslant=-2.05, xscale=0.7,anchor=north west] at (0.25,4.75) {\large\textbf{layer 8}};
        %% \node[red!80, xslant=0,yslant=-0.85] at (2.5,-3) {\large\textbf{\the\value{numCells}}};
        \addtocounter{totalNumCells}{\value{numCells}}
    \end{scope}
    \begin{scope}[
            xshift=-80,every node/.append style={
            xslant=0,yslant=0.85}, xslant=0,yslant=-1.25, xscale=0.75, yscale=1.25
            ]
        \fill[white,fill opacity=0.9] (0,0) rectangle (5,5);
        \draw[black,very thick] (0,0) rectangle (5,5);
	      \begin{axis}[view={0}{90},
            width = 6.59cm, height = 6.59cm,
            zmin=-13, zmax=0,
            point meta min = -13, point meta max = 0,
          ]
          \addplot3[surf,
            shader=flat corner,
            mesh/cols=31,
            mesh/rows=31,
            mesh/ordering=rowwise] file {data_scaled_log_layer6.csv};
	      \end{axis}
        \pgfmathsetmacro\hdeta{\dEta[6]}
        \pgfmathsetmacro\hdphi{\dPhi[6]}
        \pgfmathsetmacro\hdetaminus{\dEta[6] - 1}
        \pgfmathsetmacro\hdphiminus{\dPhi[6] - 1}
        \pgfmathsetmacro\hdetaStart{-31/2+\hdeta/2}
        \pgfmathsetmacro\hdphiStart{-31/2+\hdphi/2}
        \pgfmathsetmacro\hdetaEnd{\hdetaStart + 30 - 1}
        \pgfmathsetmacro\hdphiEnd{\hdphiStart + 30 - 1}
        \setcounter{numCells}{0}
        \ifnum\ellipse=0
        \foreach \ieta in {\hdetaStart, ..., -1} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {0, ..., \hdetaminus} {
          \foreach \iphi in {\hdphiStart, ..., -1} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          \foreach \iphi in {\hdphi, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
        }
        \foreach \ieta in {\hdeta, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
          }{}
        }
        \else
        \foreach \ieta in {\hdetaStart, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \pgfmathsetmacro\radius{ (\ieta - (0.5 * \hdeta - 0.5)) * (\ieta - (0.5 * \hdeta - 0.5)) / ((0.5 * \hdeta) * (0.5 * \hdeta))
              + (\iphi - (0.5 * \hdphi - 0.5)) * (\iphi - (0.5 * \hdphi - 0.5)) / ((0.5 * \hdphi) * (0.5 * \hdphi))}
            \ifthenelse { \lengthtest{\radius pt < 1.0 pt}} {
            \addtocounter{numCells}{1};
            }{
              \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            }
          }
        }
        \fi
        \node[xslant=0,yslant=-2.05, xscale=0.7,anchor=north west] at (0.25,4.75) {\large\textbf{layer 7}};
        %% \node[red!80, xslant=0,yslant=-0.85] at (2.5,-3) {\large\textbf{\the\value{numCells}}};
        \addtocounter{totalNumCells}{\value{numCells}}
    \end{scope}
    \begin{scope}[
            xshift=-160,every node/.append style={
            xslant=0,yslant=0.85}, xslant=0,yslant=-1.25, xscale=0.75, yscale=1.25
            ]
        \fill[white,fill opacity=0.9] (0,0) rectangle (5,5);
        \draw[black,very thick] (0,0) rectangle (5,5);
	      \begin{axis}[view={0}{90},
            width = 6.59cm, height = 6.59cm,
            zmin=-13, zmax=0,
            point meta min = -13, point meta max = 0,
          ]
          \addplot3[surf,
            shader=flat corner,
            mesh/cols=31,
            mesh/rows=31,
            mesh/ordering=rowwise] file {data_scaled_log_layer5.csv};
	      \end{axis}
        \pgfmathsetmacro\hdeta{\dEta[5]}
        \pgfmathsetmacro\hdphi{\dPhi[5]}
        \pgfmathsetmacro\hdetaminus{\dEta[5] - 1}
        \pgfmathsetmacro\hdphiminus{\dPhi[5] - 1}
        \pgfmathsetmacro\hdetaStart{-31/2+\hdeta/2}
        \pgfmathsetmacro\hdphiStart{-31/2+\hdphi/2}
        \pgfmathsetmacro\hdetaEnd{\hdetaStart + 30 - 1}
        \pgfmathsetmacro\hdphiEnd{\hdphiStart + 30 - 1}
        \setcounter{numCells}{0}
        \ifnum\ellipse=0
        \foreach \ieta in {\hdetaStart, ..., -1} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {0, ..., \hdetaminus} {
          \foreach \iphi in {\hdphiStart, ..., -1} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          \foreach \iphi in {\hdphi, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {\hdeta, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \else
        \foreach \ieta in {\hdetaStart, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \pgfmathsetmacro\radius{ (\ieta - (0.5 * \hdeta - 0.5)) * (\ieta - (0.5 * \hdeta - 0.5)) / ((0.5 * \hdeta) * (0.5 * \hdeta))
              + (\iphi - (0.5 * \hdphi - 0.5)) * (\iphi - (0.5 * \hdphi - 0.5)) / ((0.5 * \hdphi) * (0.5 * \hdphi))}
            \ifthenelse { \lengthtest{\radius pt < 1.0 pt}} {
            \addtocounter{numCells}{1};
            }{
              \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            }
          }
        }
        \fi
        \node[xslant=0,yslant=-2.05, xscale=0.7,anchor=north west] at (0.25,4.75) {\large\textbf{layer 6}};
        %% \node[red!80, xslant=0,yslant=-0.85] at (2.5,-3) {\large\textbf{\the\value{numCells}}};
        \addtocounter{totalNumCells}{\value{numCells}}
    \end{scope}
    \begin{scope}[
            xshift=-240,every node/.append style={
            xslant=0,yslant=0.85}, xslant=0,yslant=-1.25, xscale=0.75, yscale=1.25
            ]
        \fill[white,fill opacity=0.9] (0,0) rectangle (5,5);
        \draw[black,very thick] (0,0) rectangle (5,5);
	      \begin{axis}[view={0}{90},
            width = 6.59cm, height = 6.59cm,
            zmin=-13, zmax=0,
            point meta min = -13, point meta max = 0,
          ]
          \addplot3[surf,
            shader=flat corner,
            mesh/cols=31,
            mesh/rows=31,
            mesh/ordering=rowwise] file {data_scaled_log_layer4.csv};
	      \end{axis}
        \pgfmathsetmacro\hdeta{\dEta[4]}
        \pgfmathsetmacro\hdphi{\dPhi[4]}
        \pgfmathsetmacro\hdetaminus{\dEta[4] - 1}
        \pgfmathsetmacro\hdphiminus{\dPhi[4] - 1}
        \pgfmathsetmacro\hdetaStart{-31/2+\hdeta/2}
        \pgfmathsetmacro\hdphiStart{-31/2+\hdphi/2}
        \pgfmathsetmacro\hdetaEnd{\hdetaStart + 30 - 1}
        \pgfmathsetmacro\hdphiEnd{\hdphiStart + 30 - 1}
        \setcounter{numCells}{0}
        \ifnum\ellipse=0
        \foreach \ieta in {\hdetaStart, ..., -1} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {0, ..., \hdetaminus} {
          \foreach \iphi in {\hdphiStart, ..., -1} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          \foreach \iphi in {\hdphi, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {\hdeta, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \else
        \foreach \ieta in {\hdetaStart, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \pgfmathsetmacro\radius{ (\ieta - (0.5 * \hdeta - 0.5)) * (\ieta - (0.5 * \hdeta - 0.5)) / ((0.5 * \hdeta) * (0.5 * \hdeta))
              + (\iphi - (0.5 * \hdphi - 0.5)) * (\iphi - (0.5 * \hdphi - 0.5)) / ((0.5 * \hdphi) * (0.5 * \hdphi))}
            \ifthenelse { \lengthtest{\radius pt < 1.0 pt}} {
            \addtocounter{numCells}{1};
            }{
              \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            }
          }
        }
        \fi
        \node[xslant=0,yslant=-2.05, xscale=0.7,anchor=north west] at (0.25,4.75) {\large\textbf{layer 5}};
        %% \node[red!80, xslant=0,yslant=-0.85] at (2.5,-3) {\large\textbf{\the\value{numCells}}};
        \addtocounter{totalNumCells}{\value{numCells}}
    \end{scope}
    \begin{scope}[
            xshift=-320,every node/.append style={
            xslant=0,yslant=0.85}, xslant=0,yslant=-1.25, xscale=0.75, yscale=1.25
            ]
        \fill[white,fill opacity=0.9] (0,0) rectangle (5,5);
        \draw[black,very thick] (0,0) rectangle (5,5);
	      \begin{axis}[view={0}{90},
            width = 6.59cm, height = 6.59cm,
            zmin=-13, zmax=0,
            point meta min = -13, point meta max = 0,
          ]
          \addplot3[surf,
            shader=flat corner,
            mesh/cols=31,
            mesh/rows=31,
            mesh/ordering=rowwise] file {data_scaled_log_layer3.csv};
	      \end{axis}
        \pgfmathsetmacro\hdeta{\dEta[3]}
        \pgfmathsetmacro\hdphi{\dPhi[3]}
        \pgfmathsetmacro\hdetaminus{\dEta[3] - 1}
        \pgfmathsetmacro\hdphiminus{\dPhi[3] - 1}
        \pgfmathsetmacro\hdetaStart{-31/2+\hdeta/2}
        \pgfmathsetmacro\hdphiStart{-31/2+\hdphi/2}
        \pgfmathsetmacro\hdetaEnd{\hdetaStart + 30 - 1}
        \pgfmathsetmacro\hdphiEnd{\hdphiStart + 30 - 1}
        \setcounter{numCells}{0}
        \ifnum\ellipse=0
        \foreach \ieta in {\hdetaStart, ..., -1} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {0, ..., \hdetaminus} {
          \foreach \iphi in {\hdphiStart, ..., -1} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          \foreach \iphi in {\hdphi, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {\hdeta, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \else
        \foreach \ieta in {\hdetaStart, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \pgfmathsetmacro\radius{ (\ieta - (0.5 * \hdeta - 0.5)) * (\ieta - (0.5 * \hdeta - 0.5)) / ((0.5 * \hdeta) * (0.5 * \hdeta))
              + (\iphi - (0.5 * \hdphi - 0.5)) * (\iphi - (0.5 * \hdphi - 0.5)) / ((0.5 * \hdphi) * (0.5 * \hdphi))}
            \ifthenelse { \lengthtest{\radius pt < 1.0 pt}} {
            \addtocounter{numCells}{1};
            }{
              \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            }
          }
        }
        \fi
        \node[xslant=0,yslant=-2.05, xscale=0.7,anchor=north west] at (0.25,4.75) {\large\textbf{layer 4}};
        %% \node[red!80, xslant=0,yslant=-0.85] at (2.5,-3) {\large\textbf{\the\value{numCells}}};
        \addtocounter{totalNumCells}{\value{numCells}}
    \end{scope}
    \begin{scope}[
            xshift=-400,every node/.append style={
            xslant=0,yslant=0.85}, xslant=0,yslant=-1.25, xscale=0.75, yscale=1.25
            ]
        \fill[white,fill opacity=0.9] (0,0) rectangle (5,5);
        \draw[black,very thick] (0,0) rectangle (5,5);
	      \begin{axis}[view={0}{90},
            width = 6.59cm, height = 6.59cm,
            zmin=-13, zmax=0,
            point meta min = -13, point meta max = 0,
          ]
          \addplot3[surf,
            shader=flat corner,
            mesh/cols=31,
            mesh/rows=31,
            mesh/ordering=rowwise]
          file {data_scaled_log_layer2.csv};
	      \end{axis}
        \pgfmathsetmacro\hdeta{\dEta[2]}
        \pgfmathsetmacro\hdphi{\dPhi[2]}
        \pgfmathsetmacro\hdetaminus{\dEta[2] - 1}
        \pgfmathsetmacro\hdphiminus{\dPhi[2] - 1}
        \pgfmathsetmacro\hdetaStart{-31/2+\hdeta/2}
        \pgfmathsetmacro\hdphiStart{-31/2+\hdphi/2}
        \pgfmathsetmacro\hdetaEnd{\hdetaStart + 30 - 1}
        \pgfmathsetmacro\hdphiEnd{\hdphiStart + 30 - 1}
        \setcounter{numCells}{0}
        \ifnum\ellipse=0
        \foreach \ieta in {\hdetaStart, ..., -1} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {0, ..., \hdetaminus} {
          \foreach \iphi in {\hdphiStart, ..., -1} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          \foreach \iphi in {\hdphi, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {\hdeta, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \else
        \foreach \ieta in {\hdetaStart, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \pgfmathsetmacro\radius{ (\ieta - (0.5 * \hdeta - 0.5)) * (\ieta - (0.5 * \hdeta - 0.5)) / ((0.5 * \hdeta) * (0.5 * \hdeta))
              + (\iphi - (0.5 * \hdphi - 0.5)) * (\iphi - (0.5 * \hdphi - 0.5)) / ((0.5 * \hdphi) * (0.5 * \hdphi))}
            \ifthenelse { \lengthtest{\radius pt < 1.0 pt}} {
            \addtocounter{numCells}{1};
            }{
              \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            }
          }
        }
        \fi
        \node[xslant=0,yslant=-2.05, xscale=0.7,anchor=north west] at (0.25,4.75) {\large\textbf{layer 3}};
        %% \node[red!80, xslant=0,yslant=-0.85] at (2.5,-3) {\large\textbf{\the\value{numCells}}};
        \addtocounter{totalNumCells}{\value{numCells}}
    \end{scope}
    \begin{scope}[
            xshift=-480,every node/.append style={
            xslant=0,yslant=0.85}, xslant=0,yslant=-1.25, xscale=0.75, yscale=1.25
            ]
        \fill[white,fill opacity=0.9] (0,0) rectangle (5,5);
        \draw[black,very thick] (0,0) rectangle (5,5);
	      \begin{axis}[view={0}{90},
            width = 6.59cm, height = 6.59cm,
            zmin=-13, zmax=0,
            point meta min = -13, point meta max = 0,
          ]
          \addplot3[surf,
            shader=flat corner,
            mesh/cols=31,
            mesh/rows=31,
            mesh/ordering=rowwise] file {data_scaled_log_layer1.csv};
	      \end{axis}
        \pgfmathsetmacro\hdeta{\dEta[1]}
        \pgfmathsetmacro\hdphi{\dPhi[1]}
        \pgfmathsetmacro\hdetaminus{\dEta[1] - 1}
        \pgfmathsetmacro\hdphiminus{\dPhi[1] - 1}
        \pgfmathsetmacro\hdetaStart{-31/2+\hdeta/2}
        \pgfmathsetmacro\hdphiStart{-31/2+\hdphi/2}
        \pgfmathsetmacro\hdetaEnd{\hdetaStart + 30 - 1}
        \pgfmathsetmacro\hdphiEnd{\hdphiStart + 30 - 1}
        \setcounter{numCells}{0}
        \ifnum\ellipse=0
        \foreach \ieta in {\hdetaStart, ..., -1} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {0, ..., \hdetaminus} {
          \foreach \iphi in {\hdphiStart, ..., -1} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          \foreach \iphi in {\hdphi, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {\hdeta, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \else
        \foreach \ieta in {\hdetaStart, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \pgfmathsetmacro\radius{ (\ieta - (0.5 * \hdeta - 0.5)) * (\ieta - (0.5 * \hdeta - 0.5)) / ((0.5 * \hdeta) * (0.5 * \hdeta))
              + (\iphi - (0.5 * \hdphi - 0.5)) * (\iphi - (0.5 * \hdphi - 0.5)) / ((0.5 * \hdphi) * (0.5 * \hdphi))}
            \ifthenelse { \lengthtest{\radius pt < 1.0 pt}} {
            \addtocounter{numCells}{1};
            }{
              \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            }
          }
        }
        \fi
        \node[xslant=0,yslant=-2.05, xscale=0.7,anchor=north west] at (0.25,4.75) {\large\textbf{layer 2}};
        %% \node[red!80, xslant=0,yslant=-0.85] at (2.5,-3) {\large\textbf{\the\value{numCells}}};
        \addtocounter{totalNumCells}{\value{numCells}}
    \end{scope}
    \begin{scope}[
            xshift=-550,every node/.append style={
            xslant=0,yslant=0.85}, xslant=0,yslant=-1.25, xscale=0.75, yscale=1.25
            ]
        \fill[white,fill opacity=0.] (0,0) rectangle (5,5);
        \draw[black,very thick] (0,0) rectangle (5,5);
	      \begin{axis}[view={0}{90},
            width = 6.59cm, height = 6.59cm,
            zmin=-13, zmax=0,
            point meta min = -13, point meta max = 0,
          ]
          \addplot3[surf, %opacity=0.4,
            shader=flat corner,
            mesh/cols=31,
            mesh/rows=31,
            mesh/ordering=rowwise] file {data_scaled_log_layer0.csv};
	      \end{axis}
        \pgfmathsetmacro\hdeta{\dEta[0]}
        \pgfmathsetmacro\hdphi{\dPhi[0]}
        \pgfmathsetmacro\hdetaminus{\dEta[0] - 1}
        \pgfmathsetmacro\hdphiminus{\dPhi[0] - 1}
        \pgfmathsetmacro\hdetaStart{-31/2+\hdeta/2}
        \pgfmathsetmacro\hdphiStart{-31/2+\hdphi/2}
        \pgfmathsetmacro\hdetaEnd{\hdetaStart + 30 - 1}
        \pgfmathsetmacro\hdphiEnd{\hdphiStart + 30 - 1}
        \setcounter{numCells}{0}
        \ifnum\ellipse=0
        \foreach \ieta in {\hdetaStart, ..., -1} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          }
        \foreach \ieta in {0, ..., \hdetaminus} {
          \foreach \iphi in {\hdphiStart, ..., -1} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
          \foreach \iphi in {\hdphi, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
            }{}
        }
        \foreach \ieta in {\hdeta, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            \addtocounter{numCells}{1};
          }{}
        }
        \else
        \foreach \ieta in {\hdetaStart, ..., \hdetaEnd} {
          \foreach \iphi in {\hdphiStart, ..., \hdphiEnd} {
            \pgfmathsetmacro\radius{ (\ieta - (0.5 * \hdeta - 0.5)) * (\ieta - (0.5 * \hdeta - 0.5)) / ((0.5 * \hdeta) * (0.5 * \hdeta))
              + (\iphi - (0.5 * \hdphi - 0.5)) * (\iphi - (0.5 * \hdphi - 0.5)) / ((0.5 * \hdphi) * (0.5 * \hdphi))}
            \ifthenelse { \lengthtest{\radius pt < 1.0 pt}} {
            \addtocounter{numCells}{1};
            }{
              \fill[white] ({2.5-\hdeta * 0.5 * \dr + (\ieta + 0.5) * \dr},{2.5-\hdphi * 0.5 * \dr+ (\iphi + 0.5) * \dr}) rectangle ({2.5 - \hdeta * 0.5 * \dr + (\ieta + 1.5) * \dr},{2.5 - \hdphi * 0.5 * \dr + (\iphi + 1.5) * \dr});
            }
          }
        }
        \fi
        \node[xslant=0,yslant=-2.05, xscale=0.7,anchor=north west] at (0.25,4.75) {\large\textbf{layer 1}};
%        \node[red!80, xslant=0,yslant=-0.85] at (2.5,-3) {\large\textbf{\the\value{numCells}}};
%         \addtocounter{totalNumCells}{\value{numCells}};
        %% \node[red!80, xslant=0,yslant=-0.85] at (32.5,19.5) {\LARGE\textbf{ $\rightarrow$ \the\value{totalNumCells} cells}};
    \end{scope}
\end{tikzpicture}

\end{document}
